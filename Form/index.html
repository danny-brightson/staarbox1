
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-CJM0SLEFQZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-CJM0SLEFQZ');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="google-site-verification" content="U4WrpzFDmaHcuK-NfsTwmPedGPnYUGSSiPciP5e0z18" />
  <meta name="facebook-domain-verification" content="61sleqq2sotq6rqysbiv9mide254nk" />
  <meta name="robots" content="noindex, nofollow">

  <title>Checkout - Staarbox</title>

  <!-- CSS & libs (kept as your project) -->
  <link rel="stylesheet" href="../Css/index.css" />
  <link rel="stylesheet" href="../Css/bootstrap.min.css" />
  <link rel="stylesheet" href="../Css/swiper.css" />
  <link rel="stylesheet" href="../Css/fontawesome.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link rel="stylesheet" href="../Css/googlefonts.css" />
  <link rel="stylesheet" href="../Css/AOS.css" />
  <link rel="stylesheet" href="../Css/Mdb.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    /* Layout */
    body { font-family: Poppins, Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
    .checkout-container { display:flex; justify-content:center; max-width:1200px; margin:auto; padding:8px; }
    .checkout-form { background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.08); width:100%; }
    h2.section-title { margin:6px 0 14px; font-size:18px; }
    .form-row { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:6px; }
    .form-group { box-sizing:border-box; }
    .form-group label { display:block; font-weight:600; margin-bottom:6px; font-size:14px; }
    .form-group input, .form-group textarea, .form-group select { width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px; box-sizing:border-box; }
    .half { flex: 1 1 calc(50% - 15px); min-width: 200px; } /* default half */
    .full { flex: 1 1 100%; } /* full-width */
    .pay-btn { width:100%; background:#4CAF50; color:white; font-size:16px; padding:12px; border:none; border-radius:8px; cursor:pointer; margin-top:10px; }
    .pay-btn:hover { background:#45a049; }
    .small-btn { padding:8px 10px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .muted { color:#666; font-size:13px; }
    .error { color:#c0392b; font-size:13px; margin-top:6px; min-height:16px; } /* inline errors */
    .customer-card { border:1px solid #eee; padding:12px; border-radius:10px; margin-bottom:12px; background:#fafafa; position:relative; }
    .customer-header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px; }
    .remove-customer { background:#fff; border:1px solid #e74c3c; color:#e74c3c; padding:6px 8px; border-radius:6px; cursor:pointer; font-weight:600; }
    .hidden-summary { display:none; }
    .plan-select { max-width:220px; }
    .egg-select { max-width:160px; }
    .billing-dynamic .form-row { margin-bottom:8px; }
    @media (max-width: 767px) {
      .half { flex: 1 1 100%; min-width: auto; }
      .form-row { gap:10px; }
      .checkout-form { padding:14px; }
    }
    @media (min-width: 768px) and (max-width: 1100px) {
      .half { min-width: 220px; }
    }
    label small { color:#666; font-weight:400; }
  </style>
</head>
<body>
<header>
  <nav class="navbar container-fluid" id="home">
    <div class="logo"><a href="#"><img src="../Image/staarbox.png" height="60" width="100" alt="StaarBox"></a></div>
    <div class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></div>
    <div class="nav-links" id="navLinks">
      <ul>
      <li><a href="../index.html">Home</a></li>
      <li><a href="../Aboutus/" class="active">Aboutus</a></li>
      <li><a href="../Contactus/">Contact</a></li>
    </ul></div>
  </nav>
</header>

<div class="checkout-container">
  <div class="checkout-form" role="main" aria-labelledby="checkoutHeading">
    <h2 id="checkoutHeading" class="section-title">Customer Details</h2>

    <form id="checkoutForm" autocomplete="on" novalidate>
      <div id="customersContainer">
        <template id="customerTemplate">
          <div class="customer-card customer-form" data-customer-index="{index}">
            <div class="customer-header">
              <div style="font-weight:700;">Customer <span class="customer-number">{num}</span></div>
              <div>
                <button type="button" class="remove-customer" data-action="remove">Remove</button>
              </div>
            </div>

            <!-- dynamic fields -->
            <div class="customer-fields"></div>

            <div class="form-row" style="margin-top:8px;">
              <div class="form-group half">
                <label>Egg Preferred</label>
                <select data-key="isEggadded" class="c_egg egg-select">
                  <option value="false" selected>No</option>
                  <option value="true">Yes</option>
                </select>
              </div>
            </div>
          </div>
        </template>
      </div>

      <div class="form-group">
        <label>Delivery Notes (Optional)</label>
        <textarea id="s_notes" rows="3" placeholder="Any special instructions for delivery"></textarea>
        <div class="error" id="err_s_notes"></div>
      </div>

      <div class="left-alone">
        <label><input type="checkbox" id="useSame" checked> Use this as billing address</label>
      </div>

      <div id="billingForm" style="display:none; margin-top:6px;">
        <h2 class="section-title">Billing Details</h2>

        <div class="form-row">
          <div class="form-group half">
            <label>First Name</label>
            <input type="text" data-key="firstName" id="b_fname" pattern="[A-Za-z ]+" title="Only letters allowed">
            <div class="error err_b_firstName"></div>
          </div>
          <div class="form-group half">
            <label>Last Name</label>
            <input type="text" data-key="lastName" id="b_lname" pattern="[A-Za-z ]+" title="Only letters allowed">
            <div class="error err_b_lastName"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group half">
            <label>Email</label>
            <input type="email" data-key="email" id="b_email">
            <div class="error err_b_email"></div>
          </div>
          <div class="form-group half">
            <label>Company Name (Optional)</label>
            <!-- === company optional now === -->
            <input type="text" data-key="companyName" id="b_company" placeholder="Enter Company Name" pattern="[A-Za-z0-9 &.-]+">
            <div class="error err_b_companyName"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group half">
            <label>Phone</label>
            <input type="tel" data-key="phone" id="b_phone" pattern="^[0-9]{10}$" maxlength="10" title="Enter 10-digit phone number">
            <div class="error err_b_phone"></div>
          </div>
          <div class="form-group half">
            <label>Pincode</label>
            <input type="text" data-key="pincode" id="b_zip" pattern="^[0-9]{6}$" maxlength="6" title="Enter 6-digit pincode">
            <div class="error err_b_pincode"></div>
          </div>
        </div>

        <div class="billing-dynamic"></div>

        <div class="form-row">
          <div class="form-group full">
            <label>GST Number (Optional)</label>
            <!-- === gst optional now === -->
            <input type="text" data-key="gstNumber" id="b_gst" placeholder="Enter GST Number" pattern="^([0-9]{2})([A-Z]{5})([0-9]{4})([A-Z]{1})(Z{1})([0-9A-Z]{1})$">
            <div class="error err_b_gstNumber"></div>
          </div>
        </div>
      </div>

      <button type="submit" class="pay-btn" id="saveBtn">Save</button>
    </form>
  </div>
</div>

<div class="hidden-summary" aria-hidden="true">
  <span id="planName"></span>
  <span id="basePrice"></span>
  <span id="cgst"></span>
  <span id="sgst"></span>
  <span id="discountAmt"></span>
  <span id="totalPrice"></span>
</div>
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCfaDlnAA4Hx5dDpehaMgUQ7ClYmMN0i9M&libraries=places">
</script>

<script>
  
/************* Utilities ****************/
function calculateAge(dob) {
  if (!dob) return 0;
  const birth = new Date(dob);
  const today = new Date();
  let age = today.getFullYear() - birth.getFullYear();
  const m = today.getMonth() - birth.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
  return age;
}

/************* Summary (unchanged) *************/
const params = new URLSearchParams(window.location.search);
const plan = params.get("plan") || "Standard";
const price = parseFloat(params.get("price")) || 0;
const cgst = price * 0.025;
const sgst = price * 0.025;
const total = price + cgst + sgst;
try { localStorage.setItem("Amount", total); } catch (e) {}
if (document.getElementById("planName")) document.getElementById("planName").textContent = plan;
if (document.getElementById("basePrice")) document.getElementById("basePrice").textContent = "₹" + price.toFixed(2);
if (document.getElementById("cgst")) document.getElementById("cgst").textContent = "₹" + cgst.toFixed(2);
if (document.getElementById("sgst")) document.getElementById("sgst").textContent = "₹" + sgst.toFixed(2);
if (document.getElementById("totalPrice")) document.getElementById("totalPrice").textContent = "₹" + total.toFixed(2);

/************* Field configs *************/
/* All customer/billing fields will be created required by JS OR we keep optional explicitly for company/gst. */
const customerFields = [
  { key: "firstName", label: "First Name", type: "text", required: true },
  { key: "lastName", label: "Last Name", type: "text", required: false },
  { key: "email", label: "Email", type: "email", required: true },
  { key: "phone", label: "Phone", type: "tel", required: true, pattern: "^[0-9]{10}$", maxlength: 10 },
  { key: "pincode", label: "Pincode", type: "text", required: true, pattern: "^[0-9]{6}$", maxlength: 6 },

  { key: "addressLine1", label: "Address Line 1", placeholder:"Door / Flat / House No", type: "text", required: true, full: true },
  { key: "addressLine2", label: "Address Line 2", placeholder:"Area / Locality", type: "text", required: false, full: true },

  { key: "district", label: "District", type: "select", required: true, options: [{value:"",text:"Select"},{value:1,text:"MADURAI"}] },
  { key: "state", label: "State", type: "select", required: true, options: [{value:"",text:"Select"},{value:1,text:"TAMILNADU "}]},
  { key: "addressType", label: "Address Type", type: "select", required: true, options: [{value:"",text:"Select"},{value:"Home",text:"Home"},{value:"Office",text:"Office"},{value:"Other",text:"Other"}] },

  { key: "deliveryTiming", label: "Delivery Timing", type: "select", required: true,
    options: [
      { value: "", text: "Select" },
      { value: 1, text: "6AM-7AM" },
      { value: 2, text: "7AM-8AM" },
      { value: 3, text: "8AM-9:30AM" }
    ]
  },

  { key: "gender", label: "Gender", type: "select", required: true, options: [{value:"",text:"Select"},{value:1,text:"Male"},{value:2,text:"Female"},{value:3,text:"Other"}] },
  { key: "dob", label: "Date of Birth", type: "date", required: true },
  { key: "diabetic", label: "Do you have diabetes?", type: "select", required: true, options: [{value:"",text:"Select"},{value:"No",text:"No"},{value:"Yes",text:"Yes"}] },

  { key: "allergicToFruits", label: "Are you allergic to any fruits?", type: "select", required: true, options: [{value:"",text:"Select"},{value:"No",text:"No"},{value:"Yes",text:"Yes"}] },
  { key: "allergicFruitDetails", label: "If yes, specify the fruit(s)", type: "text", required: false, full: true },

  { key: "pregnancyStatus", label: "Are you currently pregnant?", type: "select", required: false, options: [{value:"",text:"Select"},{value:"No",text:"No"},{value:"Yes",text:"Yes"}] }
];

const billingFields = [
  { key: "firstName", label: "First Name", type: "text", required: true },
  { key: "lastName", label: "Last Name", type: "text", required: true },
  { key: "email", label: "Email", type: "email", required: true },
  /* === company optional === */
  { key: "companyName", label: "Company Name (Optional)", type: "text", required: false },
  { key: "phone", label: "Phone", type: "tel", required: true, pattern: "^[0-9]{10}$", maxlength: 10 },
  { key: "pincode", label: "Pincode", type: "text", required: true, pattern: "^[0-9]{6}$", maxlength: 6 },

  { key: "addressLine1", label: "Door / Flat / House No", type: "text", required: true, full: true },
  { key: "addressLine2", label: "Area / Locality", type: "text", required: true, full: true },
  { key: "district", label: "District", type: "text", required: false },
  { key: "state", label: "State", type: "text", required: false },
  { key: "addressType", label: "Address Type", type: "select", required: false, options: [{value:"",text:"Select"},{value:"Home",text:"Home"},{value:"Office",text:"Office"},{value:"Other",text:"Other"}] },

  /* === gst optional === */
  { key: "gstNumber", label: "GST Number (Optional)", type: "text", required: false, pattern: "^([0-9]{2})([A-Z]{5})([0-9]{4})([A-Z]{1})(Z{1})([0-9A-Z]{1})$" }
];

const customerGroups = [
  ["firstName","lastName"],
  ["email","phone"],
  ["pincode","district"],
  ["state","addressType"],
  ["addressLine1"],
  ["addressLine2"],
  ["deliveryTiming","gender"],
  ["dob","diabetic"],
  ["allergicToFruits","allergicFruitDetails"],
  ["pregnancyStatus"]
];

const billingGroups = [
  ["firstName","lastName"],
  ["email","companyName"],
  ["phone","pincode"],
  ["addressLine1"],
  ["addressLine2"],
  ["district","state"],
  ["addressType"],
  ["gstNumber"]
];

/************* Helpers: create fields & inline validation *************/
function getFieldByKey(fields, key) {
  return fields.find(f => f.key === key);
}

function clearError(el) {
  const err = el.closest('.form-group')?.querySelector('.error');
  if (err) err.textContent = '';
}

function setError(el, msg) {
  const err = el.closest('.form-group')?.querySelector('.error');
  if (err) err.textContent = msg || '';
}

function validateInputElement(input, config = {}) {
  // Using constraint validation API but showing custom messages inline
  if (!input) return true;
  const v = input.value || '';

  // required
  if (input.required && v.trim() === '') {
    setError(input, 'This field is required');
    return false;
  }

  // type=email
  if (input.type === 'email' && v) {
    const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    if (!ok) { setError(input, 'Enter a valid email'); return false; }
  }

  // pattern
  if (input.pattern && v) {
    const re = new RegExp(input.pattern);
    if (!re.test(v)) { setError(input, 'Invalid format'); return false; }
  }

  // length checks for phone/pincode
  if (input.getAttribute('data-key') === 'phone' && v) {
    if (!/^[0-9]{10}$/.test(v)) { setError(input, 'Phone must be 10 digits'); return false; }
  }
  if (input.getAttribute('data-key') === 'pincode' && v) {
    if (!/^[0-9]{6}$/.test(v)) { setError(input, 'Pincode must be 6 digits'); return false; }
  }

  // ok
  clearError(input);
  return true;
}
/* -----------------------
  Element creation & grouped rendering (unchanged mostly)
-------------------------*/
function getFieldByKey(fields, key) { return fields.find(f => f.key === key); }

function makeFieldNode(f, prefill = {}) {
  const fg = document.createElement("div");
  fg.className = "form-group";
  const label = document.createElement("label");
  label.textContent = f.label;
  fg.appendChild(label);

  let input;
  if (f.type === "select") {
    input = document.createElement("select");
    input.setAttribute("data-key", f.key);
    (f.options || []).forEach(opt => {
      const o = document.createElement("option");
      o.value = opt.value;
      o.textContent = opt.text;
      input.appendChild(o);
    });
  } else {
    input = document.createElement("input");
    input.type = f.type || "text";
    input.setAttribute("data-key", f.key);
    if (f.maxlength) input.maxLength = f.maxlength;
    if (f.pattern) input.pattern = f.pattern;
    if (f.placeholder) input.placeholder = f.placeholder;
  }

  // === required handling: billing/company/gst optional per request ===
  if (f.required) input.required = true;
  else input.required = false;

  if (prefill[f.key] !== undefined && prefill[f.key] !== null) input.value = prefill[f.key];
  input.classList.add("c_input");
  fg.appendChild(input);

  // inline error element
  const err = document.createElement("div");
  err.className = "error err_" + f.key;
  fg.appendChild(err);

  // input sanitizers - digits only for phone/pincode
  if (f.key === "phone" || f.key === "pincode") {
    input.addEventListener("input", (ev) => {
      const filtered = (ev.target.value || '').replace(/\D/g,'');
      ev.target.value = filtered.slice(0, input.maxLength || filtered.length);
      validateInputElement(input);
    });
  } else {
    input.addEventListener("input", () => validateInputElement(input));
  }

  // blur validation
  input.addEventListener("blur", () => validateInputElement(input));

  return fg;
}

function renderGroupedFields(container, fields, groups, prefill = {}) {
  container.innerHTML = "";
  groups.forEach(rowKeys => {
    const row = document.createElement("div");
    row.className = "form-row";
    if (rowKeys.length === 1) {
      const f = getFieldByKey(fields, rowKeys[0]);
      if (!f) return;
      const node = makeFieldNode(f, prefill);
      node.classList.add(f.full ? "full" : "full");
      row.appendChild(node);
    } else {
      rowKeys.forEach(k => {
        const f = getFieldByKey(fields, k);
        if (!f) return;
        const node = makeFieldNode(f, prefill);
        node.classList.add(f.full ? "full" : "half");
        row.appendChild(node);
      });
    }
    container.appendChild(row);
  });
}

/* -----------------------
  GOOGLE: Autocomplete & Geocoding helpers
-------------------------*/
function attachAutocompleteToArea(inputEl, cardElement) {
  if (!inputEl || !window.google || !google.maps?.places) return;

  let placeSelected = false;

  const autocomplete = new google.maps.places.Autocomplete(inputEl, {
    types: ['geocode'],
    componentRestrictions: { country: 'in' },
    fields: ['geometry','formatted_address','address_components']
  });

  inputEl.addEventListener('input', () => {
    placeSelected = false;
    cardElement.dataset.lat = '';
    cardElement.dataset.lng = '';
  });

  autocomplete.addListener('place_changed', () => {
    const place = autocomplete.getPlace();
    if (!place || !place.geometry) return;

    placeSelected = true;
    inputEl.value = place.formatted_address;

    const lat = place.geometry.location.lat();
    const lng = place.geometry.location.lng();

    cardElement.dataset.lat = lat;
    cardElement.dataset.lng = lng;

    const comps = place.address_components || [];
    comps.forEach(c => {
      if (c.types.includes('postal_code')) {
        const pin = cardElement.querySelector('[data-key="pincode"]');
        if (pin) pin.value = c.long_name;
      }
    });

    openMapsAt(lat, lng);
  });

  inputEl.addEventListener('blur', () => {
  setTimeout(() => {
    if (!placeSelected) {
      inputEl.value = '';
      alert('Please select Area / Locality from Google suggestions only.');
    }
  }, 200); // allow Google place_changed to fire first
});

}

const GOOGLE_API_KEY = 'AIzaSyCfaDlnAA4Hx5dDpehaMgUQ7ClYmMN0i9M'; // <-- replace

function openMapsAt(lat, lng) {
  if (!lat || !lng) return;
  const url = `https://www.google.com/maps?q=${lat},${lng}`;
  window.open(url, '_blank');
}

function setCardLocation(cardElement, lat, lng) {
  if (!cardElement) return;
  // store data attributes on the card so submit can read them
  cardElement.dataset.lat = lat;
  cardElement.dataset.lng = lng;
}


/************* Customer blocks handling *************/
let customerCount = 0;
const customersContainer = document.getElementById('customersContainer');
const templateHTML = document.getElementById('customerTemplate').innerHTML;

function createCustomerCard(prefill = {}) {
  customerCount++;
  const html = templateHTML.replace(/{index}/g, customerCount).replace(/{num}/g, customerCount);
  const wrapper = document.createElement('div');
  wrapper.innerHTML = html;
  const node = wrapper.firstElementChild;

  const removeBtn = node.querySelector('[data-action="remove"]');
  if (customerCount === 1 && removeBtn) removeBtn.style.display = 'none';

  const fieldsContainer = node.querySelector('.customer-fields');
  renderGroupedFields(fieldsContainer, customerFields, customerGroups, prefill);

  /* ============================
   PREFILL FROM LOGIN (FIRST CUSTOMER ONLY)
   ============================ */
if (customerCount === 1) {
  const storedName  = localStorage.getItem('staarbox_user_name');
  const storedPhone = localStorage.getItem('staarbox_user_phone');

  /* ---------- NAME ---------- */
  if (storedName) {
    const parts = storedName.trim().split(/\s+/);

    const firstNameInput = fieldsContainer.querySelector('[data-key="firstName"]');
    const lastNameInput  = fieldsContainer.querySelector('[data-key="lastName"]');

    if (firstNameInput && !firstNameInput.value) {
      firstNameInput.value = parts[0] || '';
    }

    if (lastNameInput && !lastNameInput.value) {
      lastNameInput.value = parts.slice(1).join(' ');
    }
  }

  /* ---------- PHONE (LOCKED) ---------- */
  if (storedPhone) {
    const phoneInput = fieldsContainer.querySelector('[data-key="phone"]');
    if (phoneInput) {
      phoneInput.value = storedPhone.replace(/\D/g, '').slice(-10);

      // hard lock
      phoneInput.readOnly = true;
      phoneInput.style.backgroundColor = '#f1f1f1';
      phoneInput.style.cursor = 'not-allowed';

      phoneInput.addEventListener('keydown', e => e.preventDefault());
      phoneInput.addEventListener('paste', e => e.preventDefault());
      phoneInput.addEventListener('focus', () => phoneInput.blur());
    }
  }
}


  const pinInput = fieldsContainer.querySelector('[data-key="pincode"]');
  if (pinInput) {
    let existing = fieldsContainer.querySelector('.pin-status');
    if (!existing) {
      const pinStatus = document.createElement('div');
      pinStatus.className = 'pin-status muted';
      pinStatus.style.marginTop = '6px';
      pinStatus.style.fontSize = '13px';
      pinStatus.id = `pinStatus-${customerCount}`;
      pinInput.parentElement.appendChild(pinStatus);
    }
  }
   // Attach autocomplete to addressLine1 (if google loaded)
const areaInput = fieldsContainer.querySelector('[data-key="addressLine2"]');
if (areaInput) {
  attachAutocompleteToArea(areaInput, node);
}




  // pregnancy logic: show only when gender indicates 'Female' AND age > 18 (strict)
  fieldsContainer.addEventListener('change', (e) => {
    const target = e.target;

    if (target.getAttribute('data-key') === 'allergicToFruits') {
      const spec = fieldsContainer.querySelector('[data-key="allergicFruitDetails"]')?.closest('.form-group');
      if (spec) spec.style.display = (target.value === 'Yes') ? 'block' : 'none';
      if (target.value !== 'Yes') {
        const inp = fieldsContainer.querySelector('[data-key="allergicFruitDetails"]');
        if (inp) inp.value = '';
      }
    }

    if (target.getAttribute('data-key') === 'gender' || target.getAttribute('data-key') === 'dob') {
      const genderVal = fieldsContainer.querySelector('[data-key="gender"]')?.value;
      const dobVal = fieldsContainer.querySelector('[data-key="dob"]')?.value;
      const age = calculateAge(dobVal);

      const pregGroup = fieldsContainer.querySelector('[data-key="pregnancyStatus"]')?.closest('.form-group');
      if (!pregGroup) return;

      // === strict age > 18 and accept numeric '2' or text 'Female' ===
      const isFemale = String(genderVal).toLowerCase() === 'female' || String(genderVal) === '2';
      if (isFemale && age > 18) {
        pregGroup.style.display = 'block';
        const pregSelect = fieldsContainer.querySelector('[data-key="pregnancyStatus"]');
        if (pregSelect) pregSelect.required = true;
      } else {
        pregGroup.style.display = 'none';
        const sel = fieldsContainer.querySelector('[data-key="pregnancyStatus"]');
        if (sel) { sel.value = ""; sel.required = false; }
      }
    }
  });

  // initial toggles
  setTimeout(() => {
    fieldsContainer.querySelectorAll('[data-key="allergicToFruits"]').forEach(t => t.dispatchEvent(new Event('change')));
    fieldsContainer.querySelectorAll('[data-key="gender"]').forEach(t => t.dispatchEvent(new Event('change')));
    fieldsContainer.querySelectorAll('[data-key="dob"]').forEach(t => t.dispatchEvent(new Event('change')));
  }, 0);

  customersContainer.appendChild(node);
  return node;
}

if (!document.querySelectorAll('.customer-card').length) createCustomerCard();

// remove/delegate
customersContainer.addEventListener('click', function (e) {
  const btn = e.target.closest('[data-action="remove"]');
  if (!btn) return;
  const card = btn.closest('.customer-card');
  if (!card) return;
  card.remove();
  const cards = customersContainer.querySelectorAll('.customer-card');
  customerCount = 0;
  cards.forEach((c) => {
    customerCount++;
    c.setAttribute('data-customer-index', customerCount);
    const numSpan = c.querySelector('.customer-number');
    if (numSpan) numSpan.textContent = customerCount;
    const rem = c.querySelector('[data-action="remove"]');
    if (rem) rem.style.display = (cards.length > 1) ? 'inline-block' : 'none';
  });
});

/************* Billing toggle *************/
// document.getElementById("useSame").addEventListener("change", function () {
//   document.getElementById("billingForm").style.display = this.checked ? "none" : "block";
// });
// document.getElementById("billingForm").style.display = document.getElementById("useSame").checked ? "none" : "block";

// /************* Geocoding helper (unchanged) *************/
// async function getLatLongFromAddress(fullAddress) {
//   if (!fullAddress || !String(fullAddress).trim()) return null;
//   const apiKey = "691e009576b9d956706916fil56d0ca";
//   const url = `https://geocode.maps.co/search?api_key=${apiKey}&q=${encodeURIComponent(fullAddress)}`;
//   try {
//     const res = await fetch(url);
//     const data = await res.json();
//     if (data && data.length > 0) return { lat: data[0].lat, lon: data[0].lon };
//     return null;
//   } catch (err) {
//     console.error("Geocode error:", err);
//     return null;
//   }
// }


/* -----------------------
  Billing autocomplete attach (when billing form is shown)
-------------------------*/
function attachAutocompleteToBilling() {
  const billingContainer = document.getElementById('billingForm');
  if (!billingContainer) return;

  const areaInput = billingContainer.querySelector('[data-key="addressLine2"]');
  if (areaInput) {
    attachAutocompleteToArea(areaInput, billingContainer);
  }
}


// Billing toggle listener to attach autocomplete when opened
document.getElementById("useSame").addEventListener("change", function () {
  document.getElementById("billingForm").style.display = this.checked ? "none" : "block";
  if (!this.checked) {
    // billing shown -> attach autocomplete
    setTimeout(attachAutocompleteToBilling, 100);
  }
});
document.getElementById("billingForm").style.display = document.getElementById("useSame").checked ? "none" : "block";
if (document.getElementById("billingForm").style.display !== 'none') attachAutocompleteToBilling();


/************* Pincode availability (unchanged) *************/
customersContainer.addEventListener('blur', function (e) {
  const t = e.target;
  if (t && t.getAttribute && t.getAttribute('data-key') === 'pincode') {
    const card = t.closest('.customer-card');
    validatePincodeForCard(t.value.trim(), card);
  }
}, true);

async function validatePincodeForCard(pin, card) {
  const pinMessageEl = card ? card.querySelector('.pin-status') : null;
  if (!pinMessageEl) return false;

  if (!pin || pin.length !== 6 || isNaN(pin)) {
    pinMessageEl.style.color = "red";
    pinMessageEl.textContent = "Invalid pincode format";
    return false;
  }
  const token = localStorage.getItem("accessToken");
  try {
    const url = `https://api.staarbox.in/api/checkPinCodeAvailability?pincode=${encodeURIComponent(pin)}`;
    const response = await fetch(url, {
      method: "GET",
      headers: { "Authorization": token ? `Bearer ${token}` : "" }
    });

    if (!response.ok) {
      pinMessageEl.style.color = "red";
      pinMessageEl.textContent = "Pincode check failed. Try again.";
      return false;
    }

    const data = await response.json();
    if (data === true) {
      pinMessageEl.style.color = "green";
      pinMessageEl.textContent = "Pincode verified ✓";
      return true;
    } else {
      pinMessageEl.style.color = "red";
      pinMessageEl.textContent = "Service not available in this pincode";
      return false;
    }
  } catch (err) {
    console.error("Pincode error:", err);
    if (pinMessageEl) {
      pinMessageEl.style.color = "red";
      pinMessageEl.textContent = "Pincode check failed. Try again.";
    }
    return false;
  }
}

/************* Form submit with inline validation *************/
document.getElementById("checkoutForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const form = e.target;

  // run validation for every input/select in the form (inline)
  const inputs = form.querySelectorAll('input[data-key], select[data-key]');
  let allValid = true;
  inputs.forEach(inp => {
    const ok = validateInputElement(inp);
    if (!ok) allValid = false;
  });

  if (!allValid) {
    // focus first invalid field
    const firstInvalid = form.querySelector('.error:not(:empty)');
    if (firstInvalid) {
      const input = firstInvalid.closest('.form-group')?.querySelector('[data-key]');
      if (input) input.focus();
    }
    return;
  }

  // proceed to build payload (same logic as before)
  const cards = document.querySelectorAll('.customer-card');
  if (!cards.length) { alert('Please add customer details'); return; }
  const resultArray = [];
  let invalid = false;

  const districtMap = { 1: "Madurai", 2: "Chennai", 3: "Coimbatore" };
  const stateMap = { 1: "Tamil Nadu", 2: "Kerala", 3: "Karnataka" };

  for (const card of cards) {
    const read = (k) => {
      const el = card.querySelector(`[data-key="${k}"]`);
      return el ? (el.value || '').toString().trim() : '';
    };

    const firstName = read('firstName');
    const lastName = read('lastName');
    const email = read('email');
    const phone = read('phone');
    const pincode = read('pincode');

    if (!firstName || !email || !phone || !pincode) invalid = true;
    // if (!/^[0-9]{10}$/.test(phone)) { invalid = true; card.querySelector('.err_phone') && (card.querySelector('.err_phone').textContent = 'Phone must be 10 digits'); }
    // if (!/^[0-9]{6}$/.test(pincode)) { invalid = true; card.querySelector('.err_pincode') && (card.querySelector('.err_pincode').textContent = 'Pincode must be 6 digits'); }
    // if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { invalid = true; card.querySelector('.err_email') && (card.querySelector('.err_email').textContent = 'Enter a valid email'); }
  if (!/^[0-9]{10}$/.test(phone)) { invalid = true; const el = card.querySelector('.err_phone'); if (el) el.textContent = 'Phone must be 10 digits'; }
    if (!/^[0-9]{6}$/.test(pincode)) { invalid = true; const el = card.querySelector('.err_pincode'); if (el) el.textContent = 'Pincode must be 6 digits'; }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { invalid = true; const el = card.querySelector('.err_email'); if (el) el.textContent = 'Enter a valid email'; }

    let districtVal = read('district');
    let stateVal = read('state');
    const districtName = districtMap[districtVal] || districtVal;
    const stateName = stateMap[stateVal] || stateVal;
    // const fullAddress = [districtName, stateName, read('pincode')].filter(Boolean).join(', ');
    // let lat = null, lon = null;
    // try {
    //   const loc = await getLatLongFromAddress(fullAddress);
    //   if (loc) { lat = Number(loc.lat); lon = Number(loc.lon); }
    // } catch (err) { console.warn('geocode failed', err); }

      // read stored lat/lng set by autocomplete (if any)
    const latAttr = card.dataset.lat;
    const lngAttr = card.dataset.lng;
    let lat = latAttr ? Number(latAttr) : null;
    let lon = lngAttr ? Number(lngAttr) : null;

    // if lat/lng missing, attempt geocode with Google
    if (!lat || !lon) {
  alert('Please select Area / Locality from Google suggestions.');
  return;
}

    const allergic = (read('allergicToFruits') || '').toString().toLowerCase() === 'yes';
    const fruitstoAvoid = allergic ? (read('allergicFruitDetails') || '') : '';
    const preg = (read('pregnancyStatus') || '').toString().toLowerCase() === 'yes';
    const eggEl = card.querySelector('[data-key="isEggadded"], .c_egg');
    let eggPref = false;
    if (eggEl) { const v = (eggEl.value || '').toString().toLowerCase(); eggPref = (v === 'true' || v === 'yes'); }

    const districtId = (() => { const v = read('district'); return v === '' ? null : Number(v); })();
    const stateId = (() => { const v = read('state'); return v === '' ? null : Number(v); })();
    const delivaryTimingId = (() => { const v = read('deliveryTiming'); return v === '' ? null : Number(v); })();
    const genderId = (() => { const v = read('gender'); return v === '' ? null : Number(v); })();

    const obj = {
      name: `${firstName}${lastName ? ' ' + lastName : ''}`,
      mailId: email,
      dOB: read('dob') || null,
      genderId: genderId,
      addressLine1: read('addressLine1') || '',
      addressLine2: read('addressLine2') || '',
      pinCode: pincode || '',
      districtId: districtId,
      stateId: stateId,
      addressType: read('addressType') || '',
      delivaryTimingId: delivaryTimingId,
      isPragnent: !!preg,
      isAllergic: !!allergic,
      fruitstoAvoid: fruitstoAvoid || '',
      phoneNumber: phone || '',
      latitude: lat,
      longtitude: lon,
      isEggPreferd: !!eggPref,
      B_firstName: '',
      B_lastName: '',
      B_email: '',
      B_phone: '',
      B_address: '',
      B_companyName: '',
      B_gstNumber: '',
      B_landmark: '',
      B_city: read('district') || '',
      B_state: read('state') || ''
    };

    resultArray.push(obj);
  }

  if (invalid) { alert('Please fill required fields: First Name, Email, Phone and Pincode for all customers correctly.'); return; }

  // billing read (same as before) ...
  const sameAsShipping = document.getElementById('useSame').checked;
  const billingVals = {
    b_firstName: '',
    b_lastName: '',
    b_email: '',
    b_phone: '',
    b_address: '',
    b_companyName: '',
    b_gstNumber: '',
    b_landmark: '',
    b_city: '',
    b_state: ''
  };

  if (sameAsShipping) {
    const firstCard = document.querySelector('.customer-card');
    if (firstCard) {
      billingVals.b_firstName = (firstCard.querySelector('[data-key="firstName"]')?.value || '').trim();
      billingVals.b_lastName  = (firstCard.querySelector('[data-key="lastName"]')?.value || '').trim();
      billingVals.b_email     = (firstCard.querySelector('[data-key="email"]')?.value || '').trim();
      billingVals.b_phone     = (firstCard.querySelector('[data-key="phone"]')?.value || '').trim();
      billingVals.b_address   = (firstCard.querySelector('[data-key="addressLine1"]')?.value || '').trim();
      billingVals.b_city      = (firstCard.querySelector('[data-key="district"]')?.value || '').trim();
      billingVals.b_state     = (firstCard.querySelector('[data-key="state"]')?.value || '').trim();
      billingVals.b_landmark  = '';
    }
  } else {
    billingVals.b_firstName = (document.getElementById('b_fname')?.value || '').trim();
    billingVals.b_lastName  = (document.getElementById('b_lname')?.value || '').trim();
    billingVals.b_email     = (document.getElementById('b_email')?.value || '').trim();
    billingVals.b_phone     = (document.getElementById('b_phone')?.value || '').trim();
    billingVals.b_address   = (document.querySelector('#billingForm [data-key="addressLine1"]')?.value || '').trim();
    billingVals.b_companyName = (document.getElementById('b_company')?.value || '').trim();
    billingVals.b_gstNumber   = (document.getElementById('b_gst')?.value || '').trim();
    billingVals.b_landmark    = '';
    billingVals.b_city = (document.querySelector('#billingForm [data-key="district"]')?.value || '').trim();
    billingVals.b_state = (document.querySelector('#billingForm [data-key="state"]')?.value || '').trim();
  }

  resultArray.forEach(item => {
    item.B_firstName = billingVals.b_firstName || '';
    item.B_lastName  = billingVals.b_lastName  || '';
    item.B_email     = billingVals.b_email     || '';
    item.B_phone     = billingVals.b_phone     || '';
    item.B_address   = billingVals.b_address   || '';
    item.B_companyName = billingVals.b_companyName || '';
    item.B_gstNumber   = billingVals.b_gstNumber || '';
    item.B_landmark    = billingVals.b_landmark || '';
    item.B_city = billingVals.b_city || item.B_city || '';
    item.B_state = billingVals.b_state || item.B_state || '';
  });

  // send same as before
  try {
    const token = localStorage.getItem('accessToken');
    const response = await fetch("https://api.staarbox.in/api/save", {
      method: "POST",
      headers: { "Content-Type": "application/json",
                'Authorization': token ? `Bearer ${token}` : ''},
      body: JSON.stringify(resultArray)
    });

    const text = await response.text();
    if (!text || text.trim() === "") {
      if (response.ok) {
        document.getElementById("saveBtn").style.display = "none";
        alert("Checkout saved (no response body).");
       // window.location.href = '../checkout/payment.html';
      } else {
        alert("Save request failed: server returned status " + response.status);
      }
      return;
    }

    let result;
    try { result = JSON.parse(text); } catch (err) {
      if (response.ok) {
        document.getElementById("saveBtn").style.display = "none";
        alert("Checkout saved: " + text);
      //  window.location.href = '../Payment/payment.html';
      } else { alert("Save request failed: " + text); }
      return;
    }

    if (response.ok) {
      if (Array.isArray(result) && result.length > 0 && result[0].id != null) {
        localStorage.setItem("CustomerId", String(result[0].id));
      } else if (result.id != null) {
        localStorage.setItem("CustomerId", String(result.id));
      }
      document.getElementById("saveBtn").style.display = "none";
      alert("Checkout saved successfully!");
      window.location.href = '../Payment/';
    } else {
      const msg = result.message || JSON.stringify(result);
      alert("❌ " + msg);
    }
  } catch (err) {
    console.error("Save request failed:", err);
    alert("An unexpected error occurred. Please try again.");
  }

});

/************* Menu toggle (kept) *************/
const toggle = document.getElementById("menuToggle");
const links = document.getElementById("navLinks");
if (toggle) toggle.addEventListener("click", () => links.classList.toggle("active"));

/************* init *************/
(function init() {
  if (!document.querySelectorAll('.customer-card').length) createCustomerCard();
})();
</script>
</body>
</html>




