
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Staarbox</title>
  
  <!-- Your CSS & Frameworks -->
  <link rel="stylesheet" href="../Css/index.css" />
  <link rel="stylesheet" href="../Css/bootstrap.min.css" />
  <link rel="stylesheet" href="../Css/swiper.css" />
  <link rel="stylesheet" href="../Css/fontawesome.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link rel="stylesheet" href="../Css/googlefonts.css" />
  <link rel="stylesheet" href="../Css/AOS.css" />
  <link rel="stylesheet" href="../Css/Mdb.css" />

  <!-- Custom Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
 .checkout-container {
      display: flex;
      justify-content: space-between;
      gap: 30px;
      max-width: 1100px;
      margin: auto;
    }

    .checkout-form, .order-summary {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0px 2px 6px rgba(0,0,0,0.1);
    }

    .checkout-form { flex: 0.6; }
    .order-summary { flex: 0.35; height: fit-content; }

    .checkout-form h2, .order-summary h3 {
      margin-bottom: 15px;
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-group {
      margin-bottom: 12px;
      flex: 1;
    }

    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .form-group input, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .promo-box {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    .promo-box input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .promo-box button {
      padding: 8px 12px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .promo-box button:hover {
      background: #0056b3;
    }

    .pay-btn {
      width: 100%;
      background: #4CAF50;
      color: white;
      font-size: 16px;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 15px;
    }

    .pay-btn:hover {
      background: #45a049;
    }

    @media (max-width: 768px) {
      .checkout-container { flex-direction: column; }
    }
    .checkout-container {
      display: flex;
      justify-content: space-between;
      gap: 30px;
      max-width: 1100px;
      margin: auto;
        padding: 20px;
    }

    .checkout-form, .order-summary {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0px 2px 6px rgba(0,0,0,0.1);
    }

    .checkout-form {
      flex: 0.6;
    }

    .order-summary {
      flex: 0.35;
      height: fit-content;
    }

    .checkout-form h2, .order-summary h3 {
      margin-bottom: 15px;
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-group {
      margin-bottom: 12px;
      flex: 1;
    }

    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .error {
      color: red;
      font-size: 12px;
      margin-top: 3px;
    }

    .checkbox {
      margin: 12px 0;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .pay-btn {
      width: 100%;
      background: #4CAF50;
      color: white;
      font-size: 16px;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .pay-btn:hover {
      background: #45a049;
    }

    @media (max-width: 768px) {
      .checkout-container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
<!-- ✅ NAVBAR -->
<header>
  <nav class="navbar container-fluid" id="home">
    <div class="logo">
      <a href="#"><img src="../Image/staarbox.png" height="60" width="100" alt="StaarBox"></a>
    </div>
    <div class="menu-toggle" id="menuToggle">
      <i class="fas fa-bars"></i>
    </div>
    <div class="nav-links" id="navLinks">
      <ul>
        <li><a href="./">Home</a></li>
        <li><a href="../Aboutus/" class="active">Aboutus</a></li>
        <li><a href="../Contactus/">Contact</a></li>
      </ul>
    </div>
  </nav>
</header>
<div class="checkout-container">
  
  <!-- LEFT: FORM -->
  <div class="checkout-form">
    <h2>Shipping Details</h2>

    <form id="checkoutForm">

      <!-- SHIPPING FORM -->
      <div id="shippingForm">
        <div class="form-row">
          <div class="form-group">
            <label>First Name</label>
             <input type="text" id="s_fname" pattern="[A-Za-z ]+" required title="Only letters allowed">
            <div class="error" id="err_s_fname"></div>
          </div>
          <div class="form-group">
            <label>Last Name</label>
              <input type="text" id="s_lname" pattern="[A-Za-z ]+" title="Only letters allowed">
          </div>
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" id="s_email">
          <div class="error" id="err_s_email"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Phone</label>
           <input type="text" id="s_phone" pattern="[0-9]{10}" maxlength="10" title="Enter 10-digit phone number" required>
            <div class="error" id="err_s_phone"></div>
          </div>
          <div class="form-group">
            <label>Pincode</label>
            <input type="text" id="s_zip" pattern="[0-9]{6}" maxlength="6" title="Enter 6-digit pincode" required>
            <div class="error" id="err_s_zip"></div>
          </div>
        </div>

        <div class="form-group">
          <label>Street Address</label>
          <input type="text" id="s_address" title="Enter address" required>
          <div class="error" id="err_s_address"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Locality/Area</label>
            <input type="text" id="s_locality" pattern="[A-Za-z0-9 ]+" title="Only letters and numbers allowed" required>
            <div class="error" id="err_s_locality"></div>
          </div>
          <div class="form-group">
            <label>Landmark</label>
              <input type="text" id="s_landmark" pattern="[A-Za-z0-9 ]+" title="Only letters and numbers allowed" required>
            <div class="error" id="err_s_landmark"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Town/City</label>
           <input type="text" id="s_city"  pattern="[A-Za-z ]+" title="Only letters allowed" required>
            <div class="error" id="err_s_city"></div>
          </div>
          <div class="form-group">
            <label>State</label>
           <input type="text" id="s_state"  pattern="[A-Za-z ]+" title="Only letters allowed" required>
          </div>
        </div>
      </div>

      <div class="checkbox">
        <label><input type="checkbox" id="useSame" checked> Use this as billing address</label>
      </div>

      <!-- BILLING FORM -->
      <div id="billingForm" style="display:none;">
        <h2>Billing Details</h2>
        <div class="form-row">
          <div class="form-group">
            <label>First Name</label>
             <input type="text" id="b_fname" pattern="[A-Za-z ]+" title="Only letters allowed">
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input type="text" id="b_lname" pattern="[A-Za-z ]+" title="Only letters allowed">
          </div>
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" id="b_email">
        </div>
       <div class="form-group">
        <label>Company Name (Optional)</label>
         <input type="text" id="b_company" placeholder="Enter Company Name" title="Optional" pattern="[A-Za-z0-9 &.-]+" title="Only letters, numbers, & , . - allowed" >
         </div>

        <div class="form-row">
          <div class="form-group">
            <label>Phone</label>
            <input type="text" id="b_phone" pattern="[0-9]{10}" maxlength="10" title="Enter 10-digit phone number" >
          </div>
          <div class="form-group">
            <label>Pincode</label>
             <input type="text" id="b_zip" pattern="[0-9]{6}" maxlength="6" title="Enter 6-digit pincode" >
          </div>
        </div>

        <div class="form-group">
          <label>Street Address</label>
           <input type="text" id="b_address" title="Enter address" >
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Town/City</label>
                 <input type="text" id="b_city"  pattern="[A-Za-z ]+" title="Only letters allowed" >
          </div>
          <div class="form-group">
            <label>State</label>
             <input type="text" id="b_state"  pattern="[A-Za-z ]+" title="Only letters allowed" >
          </div>
        </div>
       <!-- ✅ GST FIELD (Optional) -->
<div class="form-row">
  <div class="form-group" style="flex:1;">
    <label>GST Number (Optional)</label>
    <input type="text" id="b_gst" placeholder="Enter GST Number" pattern="^([0-9]{2})([A-Z]{5})([0-9]{4})([A-Z]{1})([Z]{1})([0-9A-Z]{1})$" title="Enter valid GST Number">
  </div>
</div>
      </div>
      <button type="submit" class="pay-btn" id="saveBtn">Save</button>

    </form>
  </div>

 <!-- RIGHT: ORDER SUMMARY -->
  <div class="order-summary">
    <h3>Order Summary</h3>
    <div class="summary-item"><span>Plan:</span> <span id="planName"></span></div>
    <div class="summary-item"><span>Base Price:</span> <span id="basePrice"></span></div>
    <div class="summary-item"><span>CGST (2.5%):</span> <span id="cgst"></span></div>
    <div class="summary-item"><span>SGST (2.5%):</span> <span id="sgst"></span></div>

    <!-- ✅ Promo Checkbox -->
    <div style="margin-top:12px;">
      <label><input type="checkbox" id="promoCheck"> I have a promo code</label>
    </div>

    <!-- ✅ Promo Code Section (Hidden by Default) -->
    <div id="promoSection" style="display:none;">
      <div class="promo-box">
        <input type="text" id="promoCode" placeholder="Enter promo code">
        <button id="applyPromo">Apply</button>
      </div>

      <div class="summary-item" id="discountRow" style="display:none;">
        <span>Discount:</span> 
        <span id="discountAmt" style="color:green;">-₹0.00</span>
      </div>
    </div>

    <hr>
    <div class="summary-item"><strong>Total:</strong> <strong id="totalPrice"></strong></div>

    <button class="pay-btn" id="razorpayBtn" onclick="initiatePayment()" disabled>Pay with Razorpay</button>
  </div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const plan = params.get("plan") || "Standard";
  const price = parseFloat(params.get("price")) || 0;

  const cgst = price * 0.025;
  const sgst = price * 0.025;
  let total = price + cgst + sgst;
  let discount = 0;
  localStorage.setItem("Amount", total);

  document.getElementById("planName").textContent = plan;
  document.getElementById("basePrice").textContent = "₹" + price.toFixed(2);
  document.getElementById("cgst").textContent = "₹" + cgst.toFixed(2);
  document.getElementById("sgst").textContent = "₹" + sgst.toFixed(2);
  document.getElementById("totalPrice").textContent = "₹" + total.toFixed(2);

  // ✅ Show/Hide Promo Section
  document.getElementById("promoCheck").addEventListener("change", function() {
    document.getElementById("promoSection").style.display = this.checked ? "block" : "none";
  });
// ✅ Toggle Billing Form
  document.getElementById("useSame").addEventListener("change", function () {
    document.getElementById("billingForm").style.display = this.checked ? "none" : "block";
  });

  // ✅ Apply Promo Code
  // document.getElementById("applyPromo").addEventListener("click", () => {
  //   const code = document.getElementById("promoCode").value.trim().toUpperCase();

  //   if (code === "MYFIRSTBOX") {
  //     discount = price * 0.20;
  //     total = price - discount;

  //     document.getElementById("discountRow").style.display = "flex";
  //     document.getElementById("discountAmt").textContent = "-₹" + discount.toFixed(2);
  //     document.getElementById("totalPrice").textContent = "₹" + total.toFixed(2);
  //   } 
  //   else {
  //     alert("❌ Invalid Promo Code");
  //   }
  // });
  document.getElementById("applyPromo").addEventListener("click", async () => {
  const code = document.getElementById("promoCode").value.trim();

  if (!code) {
    alert("Please enter a promo code.");
    return;
  }
   const accessToken = localStorage.getItem("accessToken");

 try {
  const res = await fetch(`https://api.staarbox.in/api/checkPromoCode?promoCode=${encodeURIComponent(code)}`, {
    method: "GET",
    headers: {
      "Authorization": `Bearer ${accessToken}`, // ✅ Attach token
      "Content-Type": "application/json"
    }
  });

  const data = await res.json();

    if (data.valid && data.discountPercentage) {
      const discount = price * (data.discountPercentage / 100);
      const newTotal = price + cgst + sgst - discount;
      localStorage.setItem("Amount", newTotal);

      document.getElementById("discountRow").style.display = "flex";
      document.getElementById("discountAmt").textContent = `-₹${discount.toFixed(2)}`;
      document.getElementById("totalPrice").textContent = `₹${newTotal.toFixed(2)}`;
    } else {
      alert("❌ Invalid Promo Code");
    }
  } catch (err) {
    console.error("Promo apply error:", err);
    alert("Server error while applying promo.");
  }
});
</script>
<script>
    const toggle = document.getElementById("menuToggle");
    const links = document.getElementById("navLinks");

    toggle.addEventListener("click", () => {
      links.classList.toggle("active");
    });
  </script>
  <script>
document.getElementById("checkoutForm").addEventListener("submit", async function (e) {
  e.preventDefault(); // Prevent form from submitting normally

  // ✅ Collect form values
 const sameAsShipping = document.getElementById("useSame").checked;

const data = {
  // Shipping Address
  firstName: document.getElementById("s_fname").value,
  lastName: document.getElementById("s_lname").value,
  email: document.getElementById("s_email").value,
  phone: document.getElementById("s_phone").value,
  pincode: document.getElementById("s_zip").value,
  address: document.getElementById("s_address").value,
  locality: document.getElementById("s_locality").value,
  landmark: document.getElementById("s_landmark").value,
  city: document.getElementById("s_city").value,
  state: document.getElementById("s_state").value,
  planName: document.getElementById("planName").textContent.trim() || "Standard",

  // Billing Address
  B_firstName: sameAsShipping ? document.getElementById("s_fname").value : document.getElementById("b_fname").value,
  B_lastName: sameAsShipping ? document.getElementById("s_lname").value : document.getElementById("b_lname").value,
  B_email: sameAsShipping ? document.getElementById("s_email").value : document.getElementById("b_email").value,
  B_phone: sameAsShipping ? document.getElementById("s_phone").value : document.getElementById("b_phone").value,
  B_address: sameAsShipping ? document.getElementById("s_address").value : document.getElementById("b_address").value,
  B_companyName:  document.getElementById("b_company").value,
  B_gstNumber: document.getElementById("b_gst").value,
  B_landmark: sameAsShipping ? document.getElementById("s_landmark").value : null,
  B_city: sameAsShipping ? document.getElementById("s_city").value : document.getElementById("b_city").value,
  B_state: sameAsShipping ? document.getElementById("s_state").value : document.getElementById("b_state").value
};


  try {
    const response = await fetch("https://api.staarbox.in/api/checkout", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(data)
    });

    const contentType = response.headers.get("content-type");

    // ✅ Handle success
    if (response.ok && contentType.includes("application/json")) {
      const result = await response.json();
      console.log("Success:", result);
 localStorage.setItem("accessToken", result.accessToken);
  localStorage.setItem("refreshToken", result.refreshToken);
   localStorage.setItem("CustomerId", result.id);

   document.getElementById("razorpayBtn").removeAttribute("disabled");
      // Use the accessToken, refreshToken, etc.
      alert("Checkout successful!");
document.getElementById("saveBtn").style.display = "none";
      // 🔁 Redirect or call next step
      // window.location.href = "/payment.html?token=" + result.accessToken;
    } else {
      // Handle text/plain or string error
      const errorMsg = await response.text();
      alert("❌ " + errorMsg);
    }

  } catch (error) {
    console.error("Error:", error);
    alert("An unexpected error occurred. Please try again.");
  }
});
</script>
<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const razorpayBtn = document.getElementById("razorpayBtn");
    const customerId = localStorage.getItem("CustomerId");

    if (customerId) {
      razorpayBtn.removeAttribute("disabled");
    } else {
      razorpayBtn.setAttribute("disabled", "true");
    }
  });
</script>

<script>
  async function initiatePayment() {
    const customerId = localStorage.getItem("CustomerId"); // 🔁 Replace this dynamically (e.g., from logged-in user)
    const amount =  localStorage.getItem("Amount"); 
    const roundedAmount = Math.round(amount);
     const accessToken = localStorage.getItem("accessToken");
;     // 🔁 Amount in rupees (Razorpay expects paise, we multiply in backend)

    try {
      // Step 1: Call backend to create Razorpay order
      const response = await fetch(`https://api.staarbox.in/api/payment/create-order?amount=${roundedAmount}&customerId=${customerId}`, {
        method: 'POST',
        headers: {
      "Authorization": `Bearer ${accessToken}` // ✅ Attach token
    }
      });
      const data = await response.json();

      if (data.error) {
        alert("Order Creation Failed: " + data.error);
        return;
      }

      // Step 2: Configure Razorpay checkout options
      const options = {
        key: data.key, // Razorpay Key ID from backend
        amount: data.amount, // Amount in paise
        currency: data.currency,
        name: "StaarBox",
        description: "Checkout Payment",
        order_id: data.orderId, // Razorpay Order ID
       handler: function (response) {
  console.log("Razorpay Payment Response:", response);
  // Call verifyPayment with all required params
  verifyPayment(
    {
      razorpay_order_id: response.razorpay_order_id,
      razorpay_payment_id: response.razorpay_payment_id,
      razorpay_signature: response.razorpay_signature
    },
    data.id, // this is the order_id returned from backend during `create-order`
    customerId,
    accessToken
  );
},
        prefill: {
  name: document.getElementById("s_fname").value + " " + document.getElementById("s_lname").value,
  email: document.getElementById("s_email").value,
  contact: document.getElementById("s_phone").value
},
        notes: {
          customer_id: customerId
        },
        theme: {
          color: "#3399cc"
        }
      };

      const rzp = new Razorpay(options);
      rzp.open();
    } catch (err) {
      console.error("Error initiating payment", err);
      alert("Failed to initiate payment.");
    }
  }

 async function verifyPayment(paymentResponse, orderId, customerId, accessToken) {
  const verifyUrl = `https://api.staarbox.in/api/payment/verify` +
    `?orderId=${paymentResponse.razorpay_order_id}` +
    `&paymentId=${paymentResponse.razorpay_payment_id}` +
    `&signature=${paymentResponse.razorpay_signature}` +
    `&cusId=${customerId}`;

  try {
    const res = await fetch(verifyUrl, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${accessToken}`
      }
    });

    const result = await res.text();
    if (res.ok) {
      alert("✅ Payment verified successfully!");
       localStorage.removeItem("Amount");
       window.location.href = "/Thankyou/"; // or whatever your actual homepage is


    } else {
      alert("❌ Payment verification failed.");
    }
  } catch (error) {
    console.error("Verification error:", error);
    alert("❌ Payment verification failed due to a network or server error.");
  }
 
}
</script>
</body>
</html>



