<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OTP Login | STAARBOX</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

  <style>
    :root {
      --brand: #02614e;
      --muted: #4a7365;
    }

    body{
      margin:0; padding:0; min-height:100vh;
      background: url('../Image/staarbox.png') center center/contain no-repeat,
                  linear-gradient(135deg,var(--brand), #eccfa1);
      background-blend-mode: overlay;
      display:flex; align-items:center; justify-content:center;
      font-family: "Poppins", sans-serif;
    }

    .otp-card {
      width:100%; max-width:460px; padding:32px; border-radius:18px;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      text-align:center; color:var(--brand);
    }

    .brand { font-size:28px; font-weight:800; margin-bottom:6px; }
    h3 { margin-top:0; margin-bottom:6px; }

    .form-control {
      border-radius:12px; padding:12px;
      border:1px solid rgba(0,0,0,0.08);
      background: #fff; color:var(--brand);
    }
    .form-control::placeholder { color: #8aa79a; }

    button { border-radius:12px; padding:12px; font-size:16px; width:100%; }

    #otp-section { display:none; margin-top:12px; }

    #status { margin-top:12px; min-height:22px; font-weight:600; color:var(--muted); }

    .small-muted { color:var(--muted); font-size:0.92rem; }

    /* ---------- recaptcha animated wrapper ---------- */
    #recaptcha-wrapper {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: all 0.5s cubic-bezier(.2,.9,.2,1);
      margin-top: 10px;
    }

    #recaptcha-wrapper.show {
      max-height: 210px; /* room for badge + box */
      opacity: 1;
      margin-bottom: 12px;
    }

    #recaptcha-wrapper.hide {
      max-height: 0;
      opacity: 0;
      margin: 0;
      padding: 0;
    }

    /* make sure the container is present (do not use display:none) */
    #recaptcha-container { width:100%; }

    /* small helper for link */
    .muted-link { color:var(--brand); font-weight:600; text-decoration:none; }
    .muted-link:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <div class="otp-card" role="main" aria-labelledby="loginTitle">
    <div class="brand">⭐ STAARBOX</div>
    <h3 id="loginTitle">Login with OTP</h3>
    <p class="small-muted">Enter your mobile number with country code</p>

    <!-- Phone section -->
    <div id="phone-section">
      <input id="phoneNumber" class="form-control mb-3" type="tel" inputmode="tel" placeholder="+91 9876543210" autocomplete="tel" />
      <!-- recaptcha wrapper: initially hidden; will slide in when Send OTP clicked -->
      <div id="recaptcha-wrapper" aria-hidden="true">
        <div id="recaptcha-container"></div>
      </div>
      <button id="sendOtpBtn" class="btn btn-warning mb-2">Send OTP</button>
    </div>

    <!-- OTP section -->
    <div id="otp-section">
      <input id="otpInput" class="form-control mb-3" type="text" placeholder="Enter 6-digit OTP" inputmode="numeric" autocomplete="one-time-code" />
      <button id="verifyOtpBtn" class="btn btn-success mb-2">Verify OTP</button>
      <p class="mt-2"><a href="#" id="resendOtp" class="small-muted text-decoration-none">Resend OTP</a></p>
    </div>

    <div id="status" class="small-muted" aria-live="polite"></div>
  </div>

  <!-- Firebase Compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>

  <script>
    // ---------- firebase config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyD78WXxyUeHl_rIlnRSQydj9WN0Ss4jqMs",
      authDomain: "staarbox-91945.firebaseapp.com",
      projectId: "staarbox-91945",
      storageBucket: "staarbox-91945.firebasestorage.app",
      messagingSenderId: "591533689732",
      appId: "1:591533689732:web:45f6abb7dbe9e42508ebd1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // ---------- dom ----------
    const phoneInput = document.getElementById('phoneNumber');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const otpSection = document.getElementById('otp-section');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const otpInput = document.getElementById('otpInput');
    const statusText = document.getElementById('status');
    const recaptchaWrapper = document.getElementById('recaptcha-wrapper');
    const recaptchaContainer = document.getElementById('recaptcha-container');
    const resendLink = document.getElementById('resendOtp');

    // ---------- helpers ----------
    function showStatus(msg, isError=false) {
      statusText.textContent = msg;
      statusText.style.color = isError ? 'crimson' : 'var(--brand)';
      console.log(msg);
    }

    // Basic phone validation (friendly messages)
    function validatePhoneInput(value) {
      const raw = String(value || '').trim();
      if (!raw) return { ok:false, msg: 'Please enter your mobile number.' };
      if (!raw.startsWith('+')) return { ok:false, msg: 'Country code missing. Start with + (example +91).' };
      const digits = raw.replace(/\D/g,'');
      if (digits.length < 10) return { ok:false, msg: 'Phone number too short. Must be at least 10 digits.' };
      if (raw.startsWith('+91') && digits.length !== 12) return { ok:false, msg: 'Indian number must be 10 digits: +919876543210' };
      return { ok:true, phone: raw };
    }

    // ---------- reCAPTCHA management (manual checkbox mode) ----------
    // NOTE: we render the widget only when user clicks "Send OTP".
    // When the user solves the checkbox, callback will add .hide class to wrapper.
    async function initRecaptchaManual() {
      // clear previous if exists
      if (window.recaptchaVerifier && typeof window.recaptchaVerifier.clear === 'function') {
        try { window.recaptchaVerifier.clear(); } catch(e){ console.warn('clear recaptcha failed', e); }
      }

      // Create a new RecaptchaVerifier that requires manual checkbox solving
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
        size: 'normal', // manual checkbox
        callback: () => {
          // This is called after user solves the checkbox
          console.log('reCAPTCHA solved by user');
          // visually hide wrapper after a short delay
          setTimeout(() => {
            recaptchaWrapper.classList.add('hide');
            recaptchaWrapper.classList.remove('show');
            recaptchaWrapper.setAttribute('aria-hidden', 'true');
          }, 500);
        },
        'expired-callback': () => {
          console.warn('reCAPTCHA expired');
          // If it expires, show it again when user attempts send again
          recaptchaWrapper.classList.remove('hide');
        }
      });

      try {
        const widgetId = await window.recaptchaVerifier.render();
        console.log('reCAPTCHA rendered (widgetId):', widgetId);
        // ensure wrapper visible for screen readers
        recaptchaWrapper.setAttribute('aria-hidden', 'false');
        return true;
      } catch (err) {
        console.error('reCAPTCHA render failed:', err);
        return false;
      }
    }

    // ---------- Send OTP flow ----------
    sendOtpBtn.addEventListener('click', async () => {
      showStatus('', false);
      sendOtpBtn.disabled = true;

      // validate phone first
      const validated = validatePhoneInput(phoneInput.value);
      if (!validated.ok) {
        showStatus('⚠️ ' + validated.msg, true);
        sendOtpBtn.disabled = false;
        return;
      }
      const phone = validated.phone;

      // reveal recaptcha area with animation
      recaptchaWrapper.classList.remove('hide');
      recaptchaWrapper.classList.add('show');
      recaptchaWrapper.setAttribute('aria-hidden', 'false');
      showStatus('Please solve the reCAPTCHA to continue...');

      // initialize the recaptcha UI (renders the checkbox)
      const recOk = await initRecaptchaManual();
      if (!recOk) {
        showStatus('reCAPTCHA failed to load. Try disabling browser shields or use a different browser.', true);
        sendOtpBtn.disabled = false;
        return;
      }

      // Now call Firebase to send OTP. Firebase will require the recaptcha solved by user before sending.
      showStatus('Waiting for you to solve reCAPTCHA and send OTP...');
      try {
        const confirmationResult = await auth.signInWithPhoneNumber(phone, window.recaptchaVerifier);
        window.confirmationResult = confirmationResult;
        // show OTP input
        otpSection.style.display = 'block';
        otpInput.focus();
        showStatus('OTP sent successfully — enter the code below.');
        // keep send button disabled to prevent duplicate requests (you may re-enable for resend)
      } catch (err) {
        console.error('sendOtp error', err);
        // friendly messages for frequent errors
        if (err && err.code === 'auth/invalid-phone-number') {
          showStatus('❌ Invalid phone number. Check digits and country code.', true);
        } else if (err && err.code === 'auth/too-many-requests') {
          showStatus('❌ Too many requests. Please wait a while and try again.', true);
        } else {
          showStatus('❌ Failed to send OTP: ' + (err && err.message ? err.message : String(err)), true);
        }
        // allow retry
        sendOtpBtn.disabled = false;
        // keep recaptcha visible so user can try again or re-solve
      }
    });

    // ---------- Verify OTP flow ----------
    verifyOtpBtn.addEventListener('click', async () => {
      showStatus('', false);
      const code = otpInput.value.trim();
      if (!code) { showStatus('⚠️ Enter the OTP code.', true); return; }
      if (!window.confirmationResult) { showStatus('⚠️ No OTP request found. Request OTP first.', true); return; }

      verifyOtpBtn.disabled = true;
      showStatus('Verifying OTP...');
      try {
        const result = await window.confirmationResult.confirm(code);
        console.log('verify result', result);
        showStatus('✅ Login successful! Redirecting...', false);
        // optional: store something or call backend here
        setTimeout(() => {
          // adjust path depending on your structure
          window.location.href = '../checkout/index.html';
        }, 900);
      } catch (err) {
        console.error('verify error', err);
        showStatus('❌ Incorrect OTP or verification failed. Try again.', true);
        verifyOtpBtn.disabled = false;
      }
    });

    // ---------- Resend / reinit ----------
    resendLink.addEventListener('click', async (e) => {
      e.preventDefault();
      // show recaptcha again and re-enable send button
      recaptchaWrapper.classList.remove('hide');
      recaptchaWrapper.classList.add('show');
      sendOtpBtn.disabled = false;
      otpSection.style.display = 'none';
      otpInput.value = '';
      showStatus('You can request a new OTP — solve reCAPTCHA and Send again.');
      // re-init recaptcha when user clicks Send (we initialize inside send flow)
    });

    // accessibility / debug: show console errors in UI when unexpected
    window.addEventListener('error', (ev) => {
      console.error('Global error', ev.error || ev.message);
    });
  </script>
</body>
</html>
